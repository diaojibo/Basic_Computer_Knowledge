## newsql详解
在将newsql前，当然要提一提其他的前辈数据库。

一个是关系型数据库(RDBMS,即SQL数据库):

 - 商业软件： Oracle，DB2
 - 开源软件：MySQL，PostgreSQL

单机版本已经很难满足海量数据的需求

还有一种后来兴起的NoSQL

 - NoSQL = Not Only SQL，意即“不仅仅是SQL，提倡运用非关系型的数据存储
 - 普遍选择牺牲掉复杂 SQL 的支持及 ACID 事务换取弹性扩展能力
 - 通常不保证强一致性的(支持最终一致)

主要分类：

 - 键值（Key-Value）数据库：如 MemcacheDB，Redis
 - 文档存储：如 MongoDB
 - 列存储，方便存储结构化和半结构化数据，方便做数据压缩，对针对某一列或者某几列的查询有非常大的IO优势： 如 HBase，Cassandra
 - 图数据库，存储图形关系(注意：不是图片)。如 Neo4J

关于NewSQL的定义是：这是一类现代关系型的DBMS，旨在为NoSQL的OLTP读写负载提供相同的可扩展性能，同时仍然提供事务的ACID保证。换句话说，这些系统希望达到NoSQL DBMS相同的可扩展性，又能保留从1970年代开始的关系模型和事务支持，使得应用可以执行大规模的并发事务，并使用SQL而不是特定的API来修改数据库的状态。


总结newsql的和核心特性：

 - 支持SQL接口
 - 支持ACID事务语义
 - 在OLTP场景下具备NoSQL的高性能、高可用、高扩展性

### old数据库的不足

#### 关系型数据库的不足

关系型数据库主要有以下三处不足：

 - 单节点并发访问量受限。在服务任意扩容和拆分的同时，由于数据库中存储的数据是有状态的，因此很难像服务一样任意拆分和扩容。单一的数据库节点承载大量的服务节点的查询和更新请求，这并非一个对等的架构部署模式。
 - 单节点数据承载量受限。单一数据库节点对数据的承载能力是有限的。数据量越大，用于查询数据所创建的索引的深度就越深。索引深度决定IO访问的次数，索引深度越深，查找越慢。
 - 分布式事务性能衰退严重。将数据库拆分之后，需要使用分布式事务代替本地事务。基于XA的分布式事务采用两阶段提交，在准备阶段即锁定资源，直至整个事务结束。在系统并发度增加时，性能会急剧衰退。

关系型数据库的不足，归根结底是设计初衷导致的。它并非分布式的产物，对分布式系统的天生不友好，导致它很难适应互联网的架构模型。面对可以随时弹性扩容的无状态服务，关系型数据库已经略显笨重。

### NoSQL的不足
NoSQL系统的关键是它们放弃了传统的DBMS强事务保证和关系模型，通过所谓最终一致性和非关系数据模型（例如键值对，图形，文档）来提高Web应用所注重的高可用性和可扩展性。

#### 键值数据库

键值数据库的代表是Redis。它在很多场景下都作为缓存使用，但Redis也同样提供落盘功能。面对通过主键查询的场景，Redis的效率非常高，**但对于内容的查询，则无能为力**。

Redis提供了集群的能力，可以将数据分散至不同的节点，有效的分散了单一节点的访问量瓶颈。如果在内存中无法加载Redis的全部数据而导致落盘，Redis的性能将有所下降，因此在数据量较大的情况下，将Redis的数据根据主键进行分片是不错的解决方案。

#### 文档数据库
文档数据库的代表是MongoDB。文档模型与面向对象的数据表达方式更加接近，它拥有自由度极高的Schema模型，可以方便的与JSON数据映射。

MongoDB的查询维度十分灵活，可以根据需要查找的内容建立索引以提升效率。此外，MongoDB在分布式的表现上也远强于关系型数据库，它可以将数据自动分片，并且能够透明化分片之间的负载均衡和失效转移。它还内置GridFS，支持大数据集的存储。

但是MongoDB无法像关系型数据库那样支持ACID事务，而是使用最终一致性事务，因此不建议将MongoDB用于非常关键的如订单、交易、账务等业务系统，而是用于论坛等对数据事务要求级别低一些的业务系统中。

#### 列族数据库
列族数据库的代表是位于Hadoop大数据体系中的HBase。它是专门用于处理海量数据的分布式数据库。

HBase通过行主键和列族来确定一条记录，每个列族中的属性是不固定的，这一点与文档数据库类似。HBase同样能够自动切分数据，使得数据存储自动具有水平扩展的能力。

HBase采用LSM Tree (Log-Structured Merge-Tree)。它将对数据的更改放在内存中，达到指定的阈值后再将更改归并后批量写入磁盘，将单个写操作转换为批量写操作，幅大提升写入速度。但在读取数据时，HBase则需要分别查找内存和磁盘中的数据，对性能产生一定影响。因此Hbase更加适合写多读少的应用。另外，**Hbase同样不支持ACID事务，并且只能通过行键来查询数据**。

### 再谈NewSQL
由于SQL和ACID事务实在太过于深入人心，而分布式数据库的需求又非常的旺盛，因此另一种数据库，NewSQL就应运而生了。

NewSQL是对各种具有分布式可扩展的数据库的简称。它继承了NoSQL对海量数据的处理能力，同时还保持了传统关系型数据库对SQL和ACID事务的支持。NewSQL的关注重点在于混合式(Hybrid)数据库，它们更倾向于找寻不再区分OLTP与OLAP查询的多模式数据库架设方案。

#### 目前一些NewSQL的案例

google的F1/Spanner是指明未来关系型数据库发展方向的里程碑式项目，这两篇论文让业界第一次看到了关系模型和NoSQL的扩展性在超庞大规模集群上融合的可行性，后面其他NewSQL产品的设计或多或少都在一定程度上参考了它。

Spanner 实际上使用 时间戳API 来对事务排序，也以此来保证外部读写一致性。如上图所示，Spanner的运维结构是： universemaster 主要是一个控制台程序，用来展示用于交互式debug所需要的所有Zone的状态信息。placement driver会周期性的与spanservers 进行通讯，从而找出需要被移动的数据进行迁移，从而满足最新的数据副本约束条件或者从而实现负载均衡。按物理分zone部署，每个zone一个 zonemaster 用于分组管理和负载均衡，多个 location proxy 用于和客户端通信，成百上千个 spanserver 用于处理逻辑。F1 客户端提供OLTP和OLAP的功能。对于 OLTP 功能，F1 客户端采用中心化的访问策略，而 OLAP 采用分布式的访问策略，并且仅访问快照。F1/Spanner是典型的计算存储分离结构，Spanner可以看做是统一的分布式存储系统，F1是构建其上的SQL处理层和数据计算层，本质上应该也属于shared storage结构。

#### TiDB
TiDB是近几年开源社区非常火爆的NewSQL代表作之一，完全使用golang开发，由国内的PingCAP公司出品。TiDB在设计上重点参考了F1/Spanner，采用计算和存储分离架构，TiDB是SQL语法解析和计算层，本身无状态，TiKV是一套分布式数据存储系统，底层基于RocksDB实现，负责具体数据的存储，数据的一致性通过Raft算法维护。

TiDB+TiKV主要用来进行OLTP事务处理，OLAP分析处理的工作则由TiSpark+快照读TiKV（最新实现了TiFlash，本身是列存结构，进一步提高AP处理效率）的方式实现。因此TiDB是一个完全的HTAP分布式数据库。

TiDB的开发人之一马晓宇说TiDB非常适合场景之一就是数据中台。

#### CockRoachDB

CockRoachDB（简称CRDB）也是NewSQL产品的代表之一，目前国内百度和网易等公司已经开始广泛使用。CRDB使用PostgreSQL协议，支持标准SQL接口。与TiDB不同的是，CRDB采用HLC混合逻辑时钟，无中心化事务管理，这在一定程度上去掉了中心节点带来瓶颈。CRDB的数据一致性也是通过Raft算法实现，底层数据存储也是基于RocksDB。和TiDB只能支持SI级别的数据隔离不同，CRDB支持SI和SSI两种隔离级别。另外值得一提的是，CRDB使用Go语言开发，只有一个单独二进制，部署非常方便。