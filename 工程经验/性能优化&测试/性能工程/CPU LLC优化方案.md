## CPU LLC优化

这个性能案例，是关于CPU 的最后一级缓存的。你应该知道，最后一级缓存（一般也就是L3），如果命中率不高的话，对系统性能会有极坏的影响。

建议采取三种性能优化策略，来提高最后一级缓存的命中率。分别是：**紧凑化数据结构**、**软件预取数据**和**去除伪共享缓存**。它

缓存不命中的比例对 CPU 的性能影响很大，尤其是最后一级缓存的不命中时，对性能的损害尤其严重。这个损害主要有两方面的性能影响：

- 第一个方面的影响很直白，就是 **CPU 的速度**受影响。我们前面讲过，内存的访问延迟，是LLC 的延迟的很多倍（比如五倍）；所以 LLC 不命中对计算速度的影响可想而知。
- 第二个方面的影响就没有那么直白了，这方面是关于**内存带宽**。我们知道，如果 LLC 没有命中，那么就只能从内存里面去取了。LLC 不命中的计数，其实就是对内存访问的计数，因为 CPU 对内存的访问总是要经过 LLC，不会跳过 LLC 的。所以每一次 LLC 不命中，就会导致一次内存访问；反之也是成立的：每一次内存访问都是因为 LLC 没有命中。



### 问题测量

针对 LLC 不命中率高的问题，我们需要衡量一下问题的严重程度。在 Linux 系统里，可以用 Perf 这个工具来测量 LLC 的不命中率。PMU 尤其可以监测 LLC 相关的指标数据，比如 LLC 读写计数、LLC 不命中计数、LLC 预先提取计数等指标。

具体用 Perf 来测量 LLC 各种计数的命令格式是：

`perf stat -e LLC-loads,LLC-load-misses,LLC-stores,LLC-store-misses`

