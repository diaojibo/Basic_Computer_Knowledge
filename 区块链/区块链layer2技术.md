## layer2技术

交易确认时间长（一个交易从发出到最终确认所经过的时间）、网络拥堵严重（如果同一个时间产生的交易太多，有些交易无法被马上处理）等等，就是区块链上所谓的“性能”问题。

对于目前基于区块链架构的公链平台的所谓“性能”的评估，应该考虑两个方面。

- TPS：这个维度衡量的是区块链在单位时间内所能处理的交易数量；我们近几年最常提到的所谓“扩容”指的就是这个维度。
- 平均处理时间

如果把以太坊比做“世界计算机”，那么目前，它只能用单核（单线程）来进行计算（同一时间只能有一个矿工来记账，或者说只有一个矿工记的账会被接受）；而所谓“扩容”可以想象为把这个“世界计算机”扩展为多核（多线程），使它在单位时间内可以同时运行多个任务（同时有多个矿工在记账，他们记的账都可以被接受），最终反映为 TPS 的提高。这也就是所谓的**Layer1扩容 ** 。

### laryer扩展

我们假设某个基于以太坊智能合约的业务流程需要 5 个步骤（交易）才能完成，也就是说，我大概有个智能合约，这个合约会有 6 个状态：初始状态，状态1，...，状态4，最终状态。那么要完成整个流程，就至少需要 5 个区块时间（从初始状态变为状态 1，需要交易 1 来完成，以次类推，则至少需要 5 个交易才能把状态变为最终状态）。

在这个例子里，区块链性能的瓶颈就变成了“区块时间”。（这是因为智能合约本质上就是一个可定制的状态机，如果它有 6 个单向变化的状态，那么必须经过 5 次变化才能达到最终状态，所以 5 个交易是必须的。）而区块时间是由公链协议所规定的，比如在比特币里是 10 分钟，在以太坊里现在大概是 16 秒，这是无法简单缩减的；整个流程的 5 个区块时间是最乐观的估计，也就是性能上限。

这就是所谓的区块链 Layer2 扩展要解决的问题。而答案就是—— off-chain（这个词的译法大概还没有共识，我这里姑且译为“脱链”，也就是不在主链上处理的意思）。

在上边例子里，我们要在主链上保存的状态就是初始状态和最终状态，中间过程的 4 个状态变动我们可以不关心，那对应的 4 个交易就可以拿到“链外”去执行；因为 off-chain 方案通常处理性能会非常高。于是从结果来看，整个处理过程只经过了一个区块时间（也就是最终状态的确认交易）就完成了。如果采用这样的方案，越复杂的流程得到的性能提升越大；比如一些有高交互性能需求的应用——游戏。另外对于支付的场景，因为相对高昂的交易手续费，那些高频的小额交易从经济上讲也显然成本过高。所以无论是支付还是合约的应用场景中，都有对 Layer2 扩展的强烈需求。

#### 技术方案

Off-chain 方案的总体思路是类似的：首先需要把主链上的部分“状态”拿到链外来，可以本地存储（基于某种客户端）或者临时存储；然后在链外做具体的操作，比如转账或者其他会影响“状态”的处理；当处理完成或者到达需要同步“状态”的时间点时，再把最终状态传回主链保存

目前已经成体系的 off-chain 技术方案大概可以分为两大类：

- 状态通道（State Channel）：以比特币的 Lightning Network [1] 和以太坊的 Raiden Network [2] 为代表
- 侧链（Side-Chain）：以以太坊的 Plasma [3] 协议为代表

##### 状态通道

状态通道是一个临时的点对点（交易的两个参与者间）价值转移通道：在开启时，通常会在主链上分别锁定一定的余额，并设定一个有效时间，并可以由任意参与方主动关闭，也就是参与方之间会基于特定的技术协议进行数据交互、价值转移（数字资产转移）；然后当可以接入网络、到达某个约定的时间点或者某方主动向主链同步数据时，会将最终结果提交到主链。

状态通道主要解决的是前边提到的高频、小额支付这样的场景中手续费过高的问题，但它的局限也很明显：

首先，它是一个临时的通路，数据并不是永久存储的，而是由参与双方自己本地保存；如果某个参与者使用的设备出现故障，损失基本上无法避免（虽然绝对的经济损失大概并不会太高）。

其次，一个状态通道仅能支持两个用户之间的价值转移；当系统中同时存在大量用户间的状态通道时，实际上就构成一个通道网络：网络中的两个用户有交易需求的时候，并不是简单地在他们两点间创建新的通道，而是通过特定的路由（routing）算法来查找是否有可用路径，而后再决定如何创建他们之间的数据通道；但这本身也增加了实现的难度和相应的技术风险。



![image-20210507222553479](C:\Users\rockctli\AppData\Roaming\Typora\typora-user-images\image-20210507222553479.png)

状态通道本身就是用来处理小额支付场景的，所以这些局限是可以接受的；即使出现不可恢复的故障，实际经济损失也不会过大。但这种技术本身显然限制了扩展的通用性和数据容量。

所以，可以进行永久存储、可以容纳更多交易、可以拥有独立的地址空间的所谓“侧链（side-chain）”方案就应运而生了。

侧链可以认为是主链的分支，是可以独立记账、独立增长的子区块链，所以其中同样会有记账人（矿工）、有永久存储机制和共识算法（因为参与侧链记账的通常会是实现了侧链协议的多个节点）。



## 侧链

对于侧链来讲，我们可以把它与主链的交互抽象为若干的“状态迁移（State Transition）”：在侧链产生时，需要把若干“状态”转移到侧链的“创世区块”中，作为侧链的“初始状态”；在侧链自己演进的过程中，需要定期把侧链的状态变动在主链进行记录，以便在发生争议或者有用户想“退出”侧链时可以恢复相应的状态。

复杂的，当然是“退出”机制。

当一个用户 A 想从侧链“退出”的时候，他应该要提出一个申请，将自己在侧链中的“状态”变动映射回主链。但因为用户在侧链中的状态变动必然是因为与其他用户进行了交互（交易）才会发生的，所以这也将会影响其他用户的“状态”。因而，这需要一个争议期，在这个期间内，如果侧链的其他用户对用户 A 的退出状态有异议，他们可以发起一个“争议（dispute）“，提交他们自己所留存的“状态”数据，并提交“技术证明”（或者请求侧链上的无利益冲突的第三方证明人提供“技术证明”，比如某个矿工或全节点提供的数据状态证明）；主链上的所谓“仲裁合约”就可以根据“技术证明”来自动化地判断谁的状态变动才是“合法”的，从而进行最终在主链上的状态更改。