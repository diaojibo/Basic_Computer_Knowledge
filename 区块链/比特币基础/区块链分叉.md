## 区块链分叉
每个具有转发功能的节点（包括矿工）收到来自其他节点的新区块时首先会验证新区块是否有效，如果有效才会进行转发，否则会拒绝该区块。

验证内容如下：

 - 区块头Hash值小于难度值（Target）（工作量证明有效）
 - 区块时间戳早于验证时间未来两小时（由于各节点时间差异和网络传输时间等原因，区块链通常允许时间戳有一定的误差）
 - 区块大小在可接受的范围内（无隔离见证的情况下为1000KB）
 - 区块中有且仅有第一笔交易为coinbase交易
 - 区块中所有交易符合交易验证的条件

1. 独立验证区块可以防止无效的区块在比特币网络中被大量传播。
2. 独立验证可防止小部分节点串通作恶导致无效区块被网络接受的情况。

### 接受新区块
当一个节点收到新区块并验证通过后，会尝试将新区块加入到区块链上，但此时可能遭遇三种不同的情况，我们来进行逐一讨论。

#### 1.将区块加入到主链上
这是一种最常见的情况，当节点收到新区块并验证通过后，直接将新区块链接到当前区块链最后一个区块后面
#### 2.将新区块加入主链产生的分支链上
由于比特币节点地域分布、网络传输等原因，每个节点在收到其他节点产生的新区块时间存在一定差异。假设有两个诚实节点X与Y在相近的时间内完成了工作量证明，此时他们还未收到其他节点广播的新区快，于是X与Y都将自己发现的区块广播到网络中，这时候会出现一些节点先接收到X发现的区块，而一些节点先接收到Y发现的区块。由于X与Y发现的区块都是有效的，所以这些节点都会把先接收到的区块加入到自己的主链中。

![](image/bitcoin14.png)

观察上图，注意到图上标了两个节点X和Y。X节点注明的是，正三角的block由这个节点产生，Y注明倒三角的block由Y产生。顺着黑实线，block分发给周围的节点。先接受到正三角的节点，验证完毕后会把正三角block加入自己的主链，表现在图中，节点也被打上正三角标记。没有接收到正三角和倒三角block的节点，node维持星星标记。

随着X与Y发现的新区块在网络中进一步被转发，先收到X发现区块的节点也会收到Y的区块，先收到Y发现区块的节点也会收到X的区块。此时这些节点会把晚收到的有效区块加入到主链产生的分支链上，整条区块链将产生短暂的分叉。

![](image/bitcoin15.png)

如上图，主链的星星block后面分叉除了正三角分支和倒三角分支。

在X与Y发现的区块被各节点接受后，矿工仅会把晚收到的有效区块连接到分支链上，然后继续基于自己的主链挖矿，即 **矿工组装的候选区块中Previous Block Hash总是对应自己主链上的最后一个区块**。

接着，节点Z完成了下一个工作量证明组装了一个新区块并开始广播该区块。节点会选择工作量最大（区块高度最高）的链作为自己的主链。并把区块放到那条分支的后头。

以上我们讨论的情况仅发生了一个区块分叉，实际中在一个区块分叉后可能再次产生同样的情况（分叉），所有节点处理方式是一样的。但是各节点在短时间内连续出现在相近时间完成工作量证明的概率呈指数下降。在比特币网络中一个区块的分叉每天都会发生，二个区块的分叉几周才会发生一次。而六个区块以上的分叉从未发生过，这也是为什么我们通常认为一笔交易得到6个区块的确认是最保险的。
