## nodejs异步io机制
了解node的异步机制，首先就要了解JS的运行机制，详细可看js的eventloop笔记。

javascript是单线程的，所以服务器端JS主线程毋庸置疑也是运行在单线程上的。那么当node遇到异步操作的时候怎么执行呢？

首先，Javascript会调用node的核心模块（lib/fs.js），核心模块再调用C++内建模块(node_file.cc)， C++内建模块判断平台(是unix还是win)，然后根据平台进行系统调用.调用nv_fs_open，在这个过程中，创建了一个请求对象FSReqWrap， 将这个请求对象推入到线程池。线程池来对这个IO代码进行处理。

线程池IO执行完毕后，通知EventLoop调用完成。JS主线程在把所有代码执行完毕以后，会不断去读取EventLoop看看有什么完成的事件，一旦检测到IO完成，就会启动对应的回调函数进行操作。

回调函数会先被丢到一个队列里，这些回调会根据顺序依次被推进JS主线程执行。

总起起来，事件循环事实上是对I/O操作的回调函数的集合做循环，也可以说是对已完成I/O操作的请求对象们的集合，对它们做循环，取请求对象完成I/O操作后的结果然后它的执行回调函数，执行完后，再对队列中下一个请求对象做同样的事。

![](image/node0.png)

单线程，事件循环，I/O线程池。在Node中，除了Javascript是单线程外，**Node自身其实是多线程的**。那么 **除了用户代码无法并行执行外，所有的I/O则是可以并行起来的**。

zwlj:对于node来说，JS本身是单线程的，执行也是单线程的，但是IO操作可以并行执行。
