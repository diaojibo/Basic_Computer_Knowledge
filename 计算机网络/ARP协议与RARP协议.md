## ARP与RARP
对于以太网，数据链路层上是根据48bit的以太网地址来确定目的接口，设备驱动程序从不检查IP数据报中的目的IP地址。**ARP协议为IP地址到对应的硬件地址之间提供动态映射**。

在以太网（ARP协议只适用于局域网）中，如果本地主机想要向某一个IP地址的主机（路由表中的下一跳路由器或者直连的主机，注意此处IP地址不一定是IP数据报中的目的IP）发包，但是并不知道其硬件地址，此时利用ARP协议提供的机制来获取硬件地址，具体过程如下：

1. 本地主机在局域网中广播ARP请求，ARP请求数据帧中包含目的主机的IP地址。意思是“如果你是这个IP地址的拥有者，请回答你的硬件地址”。

2. 目的主机的ARP层解析这份广播报文，识别出是询问其硬件地址。于是发送ARP应答包，里面包含IP地址及其对应的硬件地址。

3. 本地主机收到ARP应答后，知道了目的地址的硬件地址，之后的数据报就可以传送了。

点对点链路不使用ARP协议。

### ARP分组格式

![](image/arp0.png)


如上图，注意，这里的以太网首部就是数据链路层中的MAC帧首部，以太网协议其实就是意指局域网。以太网地址就是MAC地址。

 - 字段1是ARP请求的目的以太网地址，全1时代表广播地址。
 - 字段2是发送ARP请求的以太网地址。
 - 字段3以太网帧类型表示的是后面的数据类型，ARP请求和ARP应答这个值为0x0806。
 - 字段4表示硬件地址的类型，硬件地址不只以太网一种，是以太网类型时此值为1。
 - 字段5表示要映射的协议地址的类型，要对IPv4地址进行映射，此值为0x0800。
 - 字段6和7表示硬件地址长度和协议地址长度，MAC地址占6字节，IP地址占4字节。
 - 字段8是操作类型字段，值为1，表示进行ARP请求；值为2，表示进行ARP应答；值为3，表示进行RARP请求；值为4，表示进行RARP应答。
 - 字段9是发送端ARP请求或应答的硬件地址，这里是以太网地址，和字段2相同。
 - 字段10是发送ARP请求或应答的IP地址。
 - 字段11和12是目的端的硬件地址和协议地址。

### ARP高速缓存
每个主机都有一个ARP高速缓存表，这样避免每次发包时都需要发送ARP请求来获取硬件地址。默认老化时间是20分钟。利用arp -a命令可以查看显示系统中高速缓存的内容。

Windows下“arp -d”命令可以清除arp高速缓存表。

### RARP
具有本地磁盘的系统引导时，一般是从磁盘中的配置文件读取IP地址。但是**无盘机(没有硬盘)，如无盘工作站**，则需要采用其他方法获取ip地址。
网络上的每个系统都具有唯一的硬件地址，他是由网络接口生产厂家配置的。无盘系统的RARP实现过程是从接口卡上读取唯一的硬件地址，然后发送一份RARP请求（一帧在网络上的数据），请求某个主机在无盘系统的IP地址。
#### 工作原理

1. 主机发送一个本地的RARP广播，在此广播包中，声明自己的MAC地址并且请求任何收到此请求的RARP服务器分配一个IP地址。

2. 本地网段上的RARP服务器收到此请求后，检查其RARP列表，查找该MAC地址对应的IP地址。

3. 如果存在，RARP服务器就给源主机发送一个响应数据包并将此IP地址提供给对方主机使用。

4. 如果不存在，RARP服务器对此不做任何的响应。

5. 源主机收到从RARP服务器的响应信息，就利用得到的IP地址进行通讯；如果一直没有收到RARP服务器的响应信息，表示初始化失败。
