## ARP与RARP
对于以太网，数据链路层上是根据48bit的以太网地址来确定目的接口，设备驱动程序从不检查IP数据报中的目的IP地址。**ARP协议为IP地址到对应的硬件地址之间提供动态映射**。

在以太网（ARP协议只适用于局域网）中，如果本地主机想要向某一个IP地址的主机（路由表中的下一跳路由器或者直连的主机，注意此处IP地址不一定是IP数据报中的目的IP）发包，但是并不知道其硬件地址，此时利用ARP协议提供的机制来获取硬件地址，具体过程如下：

1. 本地主机在局域网中广播ARP请求，ARP请求数据帧中包含目的主机的IP地址。意思是“如果你是这个IP地址的拥有者，请回答你的硬件地址”。

2. 目的主机的ARP层解析这份广播报文，识别出是询问其硬件地址。于是发送ARP应答包，里面包含IP地址及其对应的硬件地址。

3. 本地主机收到ARP应答后，知道了目的地址的硬件地址，之后的数据报就可以传送了。

点对点链路不使用ARP协议。

### ARP分组格式

![](image/arp0.png)


如上图，注意，这里的以太网首部就是数据链路层中的MAC帧首部，以太网协议其实就是意指局域网。以太网地址就是MAC地址。

 - 字段1是ARP请求的目的以太网地址，全1时代表广播地址。
 - 字段2是发送ARP请求的以太网地址。
 - 字段3以太网帧类型表示的是后面的数据类型，ARP请求和ARP应答这个值为0x0806。
 - 字段4表示硬件地址的类型，硬件地址不只以太网一种，是以太网类型时此值为1。
 - 字段5表示要映射的协议地址的类型，要对IPv4地址进行映射，此值为0x0800。
 - 字段6和7表示硬件地址长度和协议地址长度，MAC地址占6字节，IP地址占4字节。
 - 字段8是操作类型字段，值为1，表示进行ARP请求；值为2，表示进行ARP应答；值为3，表示进行RARP请求；值为4，表示进行RARP应答。
 - 字段9是发送端ARP请求或应答的硬件地址，这里是以太网地址，和字段2相同。
 - 字段10是发送ARP请求或应答的IP地址。
 - 字段11和12是目的端的硬件地址和协议地址。

### ARP高速缓存
每个主机都有一个ARP高速缓存表，这样避免每次发包时都需要发送ARP请求来获取硬件地址。默认老化时间是20分钟。利用arp -a命令可以查看显示系统中高速缓存的内容。

Windows下“arp -d”命令可以清除arp高速缓存表。

### ARP缓存中毒攻击(ARP cache poisoning)
ARP认为通信双方都是安全可信的，实际上就是好骗的。当一个网络中的设备发出去一个广播ARP请求时，它只是简单的相信当收到一个ARP响应时，这个响应真的是来自正确的设备。

那么黑客就可以伪造ARP应答，将自己选择的任意的MAC地址和IP地址绑定，发送给客户端。

由于受害者的计算机会盲目地接受这个ARP响应并添加到它的ARP映射表中，因此让受害者那极易受骗的计算机将任何我选的IP地址关联到任何MAC地址。更进一步，我能广播我做的假冒ARP响应到受害者的整个网络中，欺骗网络中所有的计算机。

**通过这种技术黑客可以实现拒绝服务攻击(DoS, Denial of Service),中间人攻击(Man in the Middle),MAC洪泛(MAC Flooding)**

#### 拒绝服务(DoS, Denial of Service)
一个黑客可以只做简单的操作就将一个重要的IP地址和一个错误的MAC地址绑定。

例如，黑客可以发送一个ARP响应报文 (到你的计算机) 将你所在网络的路由器 (即我们常说的网关，译者注) IP地址和一个根本不存在的MAC地址绑定起来。你的计算机以为它知道默认网关在哪，但是事实上它的所有数据包，其目的地址都不在这个网络的网段上 (因为那个不存在的MAC不在此局域网的网段上，译者注) ，它们最后消逝在了无尽的比特流中 (即因数据包的生命周期到了而信号消失，译者注)。**仅仅这一下，黑客就能阻止你连上因特网**。

#### 中间人攻击(Man in the Middle)
黑客利用ARP缓存中毒来截获你的局域网中两台设备之间的网络信息。例如，我们假象黑客想要窃听你的计算机，192.168.0.12，和你的网络路由器 (即网关，译者注) ，192.168.0.1，之间的通信信息。

黑客先发送一个恶意的ARP “响应” ( 因为在此之前根本没有请求) 到你的路由器，将他的计算机的MAC地址和192.168.0.12绑定。

然后，黑客在发送一个恶意的ARP响应到你的计算机，将他的MAC地址和192.168.0.1绑定起来。

现在你的机器以为黑客的计算机是你的路由器了。

最后，黑客开启一个叫IP转发的系统功能。这个功能让黑客能将所有来自你的计算机的网络信息转发到路由器。

现在，只要你尝试上网，你的计算机就会将网络信息发送到黑客的机器上，然后黑客再将其转发到路由器。由于黑客仍然将你的信息转发到网络路由器，所以你**并不会察觉到他已经截获了所有你的网络信息**，或许还**窃听了你的明文密码或者劫持了你曾经安全的网络会话**。


#### MAC洪泛((MAC Flooding))
MAC洪泛是一种旨在**网络交换机switch**的ARP缓存中毒技术。当这些交换机流量超载时它们常常进入到 “集线器” 模式。在 “集线器” 模式中，交换机**由于太过繁忙而不能执行它的端口安全检测功能**，而是仅仅**向网络中的每一台计算机广播所有的网络数据**。利用大量的假冒ARP响应数据包去洪泛一台交换机的ARP映射表，黑客能使大多数制造商的交换机超载，然后当交换机进入 “集线器” 模式时，就可以**发送 (恶意的) 包去嗅探你的局域网**。

### RARP
具有本地磁盘的系统引导时，一般是从磁盘中的配置文件读取IP地址。但是**无盘机(没有硬盘)，如无盘工作站**，则需要采用其他方法获取ip地址。
网络上的每个系统都具有唯一的硬件地址，他是由网络接口生产厂家配置的。无盘系统的RARP实现过程是从接口卡上读取唯一的硬件地址，然后发送一份RARP请求（一帧在网络上的数据），请求某个主机在无盘系统的IP地址。
#### 工作原理

1. 主机发送一个本地的RARP广播，在此广播包中，声明自己的MAC地址并且请求任何收到此请求的RARP服务器分配一个IP地址。

2. 本地网段上的RARP服务器收到此请求后，检查其RARP列表，查找该MAC地址对应的IP地址。

3. 如果存在，RARP服务器就给源主机发送一个响应数据包并将此IP地址提供给对方主机使用。

4. 如果不存在，RARP服务器对此不做任何的响应。

5. 源主机收到从RARP服务器的响应信息，就利用得到的IP地址进行通讯；如果一直没有收到RARP服务器的响应信息，表示初始化失败。
