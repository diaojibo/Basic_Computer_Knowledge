## crontab
通过crontab 命令，我们可以在固定的间隔时间执行指定的系统指令或 shell script脚本。时间间隔的单位可以是分钟、小时、日、月、周及以上的任意组合。这个命令非常适合周期性的日志分析或数据备份等工作。

在linux操作系统安装完成的时候，这个服务工具便会被自动安装，操作系统会自动启动一个叫crond的守护进程。这个进程每分钟会定时检查任务，如果有要执行的任务，就会自动执行。

在linux下，我们通过以下命令来操作定时任务：

```
//编辑定时任务
crontab -e

//列出现在的定时任务
crontab -l
```

敲入`crontab -e`之后，我们就能看到并且编辑现有的一些定时计划任务了

![](image/crontab0.png)

我们在编辑定时任务的时候，可以看到有许多条目，每个条目一行代表一个定时任务。

定时任务条目的格式为：

```
f1 f2 f3 f4 f5 program
```

也就是说，每个条目有5个字段+具体命令。

各字段含义为：

 - 其中 f1 是表示分钟，f2 表示小时，f3 表示一个月份中的第几日，f4 表示月份，f5 表示一个星期中的第几天。program 表示要执行的程序。
 - 当 f1 为 \* 时表示每分钟都要执行 program，f2 为 * 时表示每小时都要执行程序，其馀类推
 - 当 f1 为 a-b 时表示从第 a 分钟到第 b 分钟这段时间内要执行，f2 为 a-b 时表示从第 a 到第 b 小时都要执行，其馀类推
 - 当 f1 为 \*/n 时表示**每 n 分钟个时间间隔执行一次**，f2 为 \*/n 表示每 n 小时个时间间隔执行一次，其馀类推
 - 当 f1 为 a, b, c,... 时表示第 a, b, c,... 分钟要执行，f2 为 a, b, c,... 时表示第 a, b, c...个小时要执行，其馀类推

这样就不难看懂下面一些实例了：

```
// 每月每天每小时的第 0 分钟执行一次 /bin/ls
0 * * * * /bin/ls

// 在 12 月内, 每天的早上 6 点到 12 点，每隔 3 个小时 0 分钟执行一次 /usr/bin/backup
0 6-12/3 * 12 * /usr/bin/backup

0 */2 * * * /sbin/service httpd restart  // 意思是每两个小时重启一次apache

50 7 * * * /sbin/service sshd start  // 意思是每天7：50开启ssh服务

```

执行任务的时候经常希望能把输出打到log里，所以在命令后面可以加上 `program >> xxx.log 2>&1` ,最后表示把错误输出重定向到标准输出。

### flock保证任务不重复
用crontab执行的定时任务，有可能某个任务没执行完，下个任务又开始执行了，这样就会同时出现两个进程，就有点蠢。

所以可以用flock文件锁，来防止多个做同一件事的任务同时执行。

flock是Linux下的文件锁，当多个进程可能会对同样的数据执行操作时，这些进程需要保证其它进程没有也在操作，以免损坏数据。

通常，这样的进程会使用一个「锁文件」，也就是建立一个文件来告诉别的进程自己在运行，如果检测到那个文件存在则认为有操作同样数据的进程在工作。这样的问题是，进程不小心意外死亡了，没有清理掉那个锁文件，那么只能由用户手动来清理了。

格式：

```
flock [-sxun][-w #] fd#
flock [-sxon][-w #] file [-c] command

-s, --shared:    获得一个共享锁
-x, --exclusive: 获得一个独占锁
-u, --unlock:    移除一个锁，通常是不需要的，脚本执行完会自动丢弃锁
-n, --nonblock:  如果没有立即获得锁，直接失败而不是等待
-w, --timeout:   如果没有立即获得锁，等待指定时间
-o, --close:     在运行命令前关闭文件的描述符号。用于如果命令产生子进程时会不受锁的管控
-c, --command:   在shell中运行一个单独的命令
-h, --help       显示帮助-V, --version:   显示版本
```

那么在crontab中的命令格式就是：

```
* * * * * flock -xn /tmp/mytest.lock -c 'some.sh >> /home/some.log'
```

xn参数，先尝试获得一个杜占锁，没有就创建，锁存在就直接失败。没必要显示加-u参数，因为脚本执行完会自动丢弃锁。
